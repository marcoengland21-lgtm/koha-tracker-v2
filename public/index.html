<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Koha">
  <meta name="theme-color" content="#020617">
  <meta name="description" content="Track koha and expenses for tangihanga">
  <link rel="apple-touch-icon" href="icon-180.png">
  <link rel="manifest" href="manifest.json">
  <title>Meaalofa ‚Ä¢ Koha Tracker</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { -webkit-tap-highlight-color: transparent; }
    body { background: #020617; margin: 0; padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom); font-family: system-ui, -apple-system, sans-serif; }
    ::-webkit-scrollbar { display: none; }
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; }
    .spin { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .pulse { animation: pulse 2s ease-in-out infinite; }
    @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .slide-in { animation: slideIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .fade-in { animation: fadeIn 0.2s ease-out; }
    @keyframes progressBar { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }
    .progress-animated { 
      background: linear-gradient(90deg, #06b6d4, #8b5cf6, #ec4899, #06b6d4);
      background-size: 300% 100%;
      animation: progressBar 2s linear infinite;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useMemo, useCallback, useRef } = React;

    // ============================================================
    // STORAGE HELPERS
    // ============================================================

    const S = {
      get: (k, d) => { try { return JSON.parse(localStorage.getItem('koha_' + k)) || d } catch { return d } },
      set: (k, v) => { try { localStorage.setItem('koha_' + k, JSON.stringify(v)) } catch {} }
    };

    // FIX: Unified scan session storage
    const ScanSession = {
      save: (data) => {
        try {
          const session = { ...data, savedAt: Date.now() };
          const json = JSON.stringify(session);
          try {
            localStorage.setItem('koha_scan_session', json);
          } catch (e) {
            sessionStorage.setItem('koha_scan_session', json);
          }
          return true;
        } catch (e) {
          console.error('Failed to save scan session:', e);
          return false;
        }
      },
      get: () => {
        try {
          const data = localStorage.getItem('koha_scan_session') || sessionStorage.getItem('koha_scan_session');
          if (!data) return null;
          const session = JSON.parse(data);
          if (Date.now() - session.savedAt > 5 * 60 * 1000) {
            ScanSession.clear();
            return null;
          }
          return session;
        } catch (e) { return null; }
      },
      clear: () => {
        localStorage.removeItem('koha_scan_session');
        sessionStorage.removeItem('koha_scan_session');
        ['pending_scan_image', 'pending_scan_time', 'pending_scan_result', 'scan_debug_log'].forEach(key => {
          localStorage.removeItem(key);
          sessionStorage.removeItem(key);
        });
      }
    };

    const copyToClipboard = async (text) => {
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
          return true;
        }
      } catch (e) {}
      try {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.left = '-9999px';
        textarea.setAttribute('readonly', '');
        document.body.appendChild(textarea);
        textarea.select();
        textarea.setSelectionRange(0, textarea.value.length);
        const success = document.execCommand('copy');
        document.body.removeChild(textarea);
        return success;
      } catch (e) { return false; }
    };

    // FIX: Improved compression
    const compressImage = (base64, maxWidth = 1200, quality = 0.7) => {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let width = img.width;
          let height = img.height;
          if (width > maxWidth) {
            height = (height * maxWidth) / width;
            width = maxWidth;
          }
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          resolve(canvas.toDataURL('image/jpeg', quality).split(',')[1]);
        };
        img.onerror = () => reject(new Error('Image load failed'));
        img.src = 'data:image/jpeg;base64,' + base64;
      });
    };

    // FIX: Compress until fits in storage
    const compressForStorage = async (base64, targetSizeKB = 400) => {
      if (base64.length < targetSizeKB * 1024) return base64;
      let quality = 0.7;
      let maxWidth = 1200;
      let result = base64;
      while (result.length > targetSizeKB * 1024 && quality > 0.1) {
        try {
          result = await compressImage(base64, maxWidth, quality);
          console.log('Compressed: ' + Math.round(result.length/1024) + 'KB at q=' + quality.toFixed(2));
        } catch (e) { break; }
        if (result.length > targetSizeKB * 1024) {
          quality -= 0.15;
          if (quality < 0.3) {
            maxWidth = Math.max(600, maxWidth - 200);
            quality = 0.5;
          }
        }
      }
      return result;
    };

    // Categories
    const EXPENSE_CATEGORIES = [
      { id: 'funeral_home', sm: 'Fale Maliu', mi: 'Whare Mate', en: 'Funeral Home', icon: 'üèõÔ∏è', group: 'tangihanga', keywords: ['funeral', 'mortuary', 'chapel', 'death', 'undertaker'] },
      { id: 'casket', sm: 'Pusa', mi: 'KƒÅwhena', en: 'Casket', icon: '‚ö±Ô∏è', group: 'tangihanga', keywords: ['casket', 'coffin', 'urn', 'burial'] },
      { id: 'plot', sm: 'Tuugamau', mi: 'UrupƒÅ', en: 'Plot', icon: 'ü™¶', group: 'tangihanga', keywords: ['cemetery', 'plot', 'grave', 'burial', 'urupa'] },
      { id: 'flowers', sm: "FugƒÅlƒÅ'au", mi: 'Putiputi', en: 'Flowers', icon: 'üíê', group: 'tangihanga', keywords: ['flower', 'florist', 'wreath', 'bouquet', 'floral'] },
      { id: 'venue', sm: 'Nofoaga', mi: 'Marae', en: 'Venue', icon: 'üè†', group: 'tangihanga', keywords: ['venue', 'hall', 'marae', 'hire', 'community'] },
      { id: 'church', sm: 'Lotu', mi: 'Karakia', en: 'Church', icon: '‚õ™', group: 'tangihanga', keywords: ['church', 'parish', 'minister', 'pastor', 'service', 'donation'] },
      { id: 'printing', sm: 'Lolomi', mi: 'Pepa', en: 'Service Sheets', icon: 'üìÑ', group: 'tangihanga', keywords: ['print', 'printing', 'service sheet', 'program', 'order of service', 'warehouse stationery', 'officeworks'] },
      { id: 'thankyou', sm: "Fa'afetai", mi: 'Mihi', en: 'Thank You Cards', icon: 'üíå', group: 'tangihanga', keywords: ['card', 'thank you', 'postage', 'stamps', 'stationery'] },
      { id: 'clothing', sm: 'Ofu', mi: 'KƒÅkahu', en: 'Clothing', icon: 'üëî', group: 'tangihanga', keywords: ['clothing', 'dress', 'suit', 'shirt', 'shoes', 'kmart', 'farmers', 'hallensteins', 'glassons'] },
      { id: 'kai', sm: "Mea'ai", mi: 'Kai', en: 'Groceries', icon: 'üõí', group: 'kai', keywords: ['countdown', 'pak n save', 'new world', 'supermarket', 'grocery', 'food', 'woolworths', 'fresh choice', 'four square', 'dairy'] },
      { id: 'catering', sm: 'Taumafa', mi: 'HƒÅkari', en: 'Catering', icon: 'üçΩÔ∏è', group: 'kai', keywords: ['catering', 'caterer', 'buffet', 'restaurant', 'takeaway', 'kfc', 'mcdonald', 'subway', 'pizza', 'sushi'] },
      { id: 'drinks', sm: 'Vai', mi: 'Inu', en: 'Drinks', icon: 'ü•§', group: 'kai', keywords: ['drink', 'beverage', 'water', 'juice', 'coffee', 'tea', 'liquor', 'beer', 'wine', 'super liquor', 'liquorland'] },
      { id: 'petrol', sm: 'Penisini', mi: 'Penehƒ´ni', en: 'Petrol', icon: '‚õΩ', group: 'travel', keywords: ['petrol', 'gas', 'fuel', 'z station', 'bp', 'mobil', 'gull', 'caltex', 'npd', 'waitomo'] },
      { id: 'flights', sm: "Va'alele", mi: 'Rererangi', en: 'Flights', icon: '‚úàÔ∏è', group: 'travel', keywords: ['flight', 'air new zealand', 'jetstar', 'airline', 'airport', 'ticket', 'travel'] },
      { id: 'accommodation', sm: 'Fale Moe', mi: 'Whare Moe', en: 'Accommodation', icon: 'üõèÔ∏è', group: 'travel', keywords: ['hotel', 'motel', 'airbnb', 'accommodation', 'stay', 'booking', 'lodge'] },
      { id: 'power', sm: 'Eletise', mi: 'Hiko', en: 'Power', icon: 'üí°', group: 'utilities', keywords: ['power', 'electricity', 'electric', 'meridian', 'genesis', 'contact', 'mercury', 'trustpower'] },
      { id: 'rubbish', sm: 'Lapisi', mi: 'Para', en: 'Rubbish', icon: 'üóëÔ∏è', group: 'utilities', keywords: ['rubbish', 'waste', 'bin', 'skip', 'cleanup', 'tip', 'dump', 'recycling', 'landfill', 'transfer station', 'refuse', 'disposal', 'trash'] },
      { id: 'misc', sm: 'Isi Mea', mi: 'ƒítahi Atu', en: 'Other', icon: 'üì¶', group: 'other', keywords: [] }
    ];

    const GIFT_CATEGORIES = [
      { id: 'aiga', sm: "ƒÄiga", mi: 'WhƒÅnau', en: 'Family', icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', color: '#ec4899', keywords: ['aunty', 'auntie', 'uncle', 'nana', 'grandma', 'grandpa', 'papa', 'mama', 'mum', 'dad', 'brother', 'sister', 'cousin', 'niece', 'nephew', 'son', 'daughter', 'in-law', 'family', 'whƒÅnau', 'aiga', 'tina', 'tama'] },
      { id: 'uo', sm: 'Uo', mi: 'Hoa', en: 'Friends', icon: 'ü§ù', color: '#8b5cf6', keywords: ['friend', 'mate', 'bro', 'sis', 'cuz', 'bestie', 'crew', 'boys', 'girls', 'gang'] },
      { id: 'galuega', sm: 'Galuega', mi: 'Mahi', en: 'Work', icon: 'üíº', color: '#06b6d4', keywords: ['work', 'office', 'team', 'staff', 'company', 'ltd', 'limited', 'inc', 'corp', 'business', 'employer', 'colleague', 'workmate', 'department', 'manager', 'boss'] },
      { id: 'lotu', sm: 'Lotu', mi: 'HƒÅhi', en: 'Church', icon: '‚õ™', color: '#f59e0b', keywords: ['church', 'parish', 'congregation', 'pastor', 'reverend', 'rev', 'father', 'minister', 'bishop', 'st ', 'saint', 'methodist', 'catholic', 'presbyterian', 'baptist', 'assembly', 'efks', 'pipc', 'cccs', 'aog'] },
      { id: 'nuu', sm: "Nu'u", mi: 'Hapori', en: 'Community', icon: 'üèòÔ∏è', color: '#10b981', keywords: ['community', 'club', 'association', 'group', 'society', 'council', 'committee', 'trust', 'foundation', 'organisation', 'organization', 'sports', 'rugby', 'league', 'netball', 'school', 'college'] },
      { id: 'isi', sm: 'Isi', mi: 'ƒítahi', en: 'Other', icon: 'üéÅ', color: '#64748b', keywords: [] }
    ];

    const CATEGORY_GROUPS = {
      tangihanga: { name: 'Maliu ‚Ä¢ Tangihanga ‚Ä¢ Funeral', color: '#a855f7', colors: ['#a855f7', '#9333ea', '#7c3aed', '#6d28d9', '#5b21b6', '#4c1d95', '#7e22ce', '#581c87', '#4a044e'] },
      kai: { name: "Mea'ai ‚Ä¢ Kai ‚Ä¢ Food", color: '#f97316', colors: ['#f97316', '#ea580c', '#fb923c'] },
      travel: { name: 'Malaga ‚Ä¢ Haerenga ‚Ä¢ Travel', color: '#06b6d4', colors: ['#06b6d4', '#0891b2', '#22d3ee'] },
      utilities: { name: 'Utilities', color: '#eab308', colors: ['#eab308', '#ca8a04'] },
      other: { name: 'Isi Mea ‚Ä¢ ƒítahi Atu ‚Ä¢ Other', color: '#64748b', colors: ['#64748b'] }
    };

    // Cloud Sync
    const CloudSync = {
      create: async (data) => {
        try {
          const res = await fetch('/api/sync', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
          const json = await res.json();
          if (!res.ok || !json.success) return { error: json.error || 'unknown' };
          return json.id;
        } catch (e) { return { error: 'fetch_error', message: e.message }; }
      },
      get: async (syncId) => {
        try {
          const res = await fetch('/api/sync?id=' + syncId.toUpperCase());
          if (!res.ok) return null;
          const json = await res.json();
          return json.success ? json.data : null;
        } catch (e) { return null; }
      },
      update: async (syncId, newData) => {
        try {
          const res = await fetch('/api/sync?id=' + syncId.toUpperCase(), { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(newData) });
          const json = await res.json();
          return json.success ? json.data : false;
        } catch (e) { return false; }
      }
    };

    // AI Validator
    const AIValidator = {
      samoanNames: ['tui', 'sio', 'afa', 'manu', 'tafa', 'latu', 'vili', 'peni', 'simi', 'ioane', 'petelo', 'paulo', 'matai', 'tama', 'sina', 'losa', 'mele', 'ana', 'maria', 'elisapeta', 'fatu', 'leota', 'taufa', 'lolo', 'ese', 'vaa', 'tagaloa', 'savea'],
      suggestGiftCategory: (donorName, existingGifts = []) => {
        if (!donorName) return null;
        const name = donorName.toLowerCase().trim();
        const nameParts = name.split(/\s+/);
        const lastName = nameParts.length > 1 ? nameParts[nameParts.length - 1] : null;
        const firstName = nameParts[0];
        for (const cat of GIFT_CATEGORIES) {
          if (cat.id === 'isi') continue;
          for (const kw of cat.keywords) {
            if (name.includes(kw.toLowerCase())) {
              return { categoryId: cat.id, category: cat, keyword: kw, confidence: kw.length > 4 ? 85 : 70, reason: 'Name contains "' + kw + '"' };
            }
          }
        }
        if (lastName && lastName.length > 2) {
          const familyGifts = existingGifts.filter(g => g.category === 'aiga');
          for (const fg of familyGifts) {
            const fgParts = fg.donor.toLowerCase().split(/\s+/);
            const fgLastName = fgParts.length > 1 ? fgParts[fgParts.length - 1] : null;
            if (fgLastName && fgLastName === lastName) {
              return { categoryId: 'aiga', category: GIFT_CATEGORIES.find(c => c.id === 'aiga'), confidence: 80, reason: 'Same surname as ' + fg.donor };
            }
          }
        }
        const isSamoanName = AIValidator.samoanNames.some(sn => firstName.includes(sn) || (lastName && lastName.includes(sn)));
        if (isSamoanName) {
          return { categoryId: 'aiga', category: GIFT_CATEGORIES.find(c => c.id === 'aiga'), confidence: 60, reason: 'Samoan name - likely whƒÅnau' };
        }
        return null;
      },
      quickValidate: (expense, category) => {
        const desc = (expense.description || '').toLowerCase();
        const isOther = category.id === 'misc';
        if (!desc) return { correct: !isOther, confidence: isOther ? 30 : 50 };
        let bestMatch = null, bestScore = 0, matchedKeyword = '';
        for (const cat of EXPENSE_CATEGORIES) {
          if (cat.id === 'misc') continue;
          for (const kw of (cat.keywords || [])) {
            if (desc.includes(kw.toLowerCase()) && kw.length > bestScore) {
              bestScore = kw.length;
              bestMatch = cat;
              matchedKeyword = kw;
            }
          }
        }
        if (bestMatch && bestMatch.id !== category.id && bestScore > 0) {
          return { correct: false, suggested: bestMatch.en, suggestedId: bestMatch.id, confidence: Math.min(95, 70 + Math.floor(bestScore / 2)), reason: 'Description contains "' + matchedKeyword + '"' };
        }
        if (isOther && desc) return { correct: false, confidence: 40, needsAI: true };
        return { correct: true, confidence: 50 };
      }
    };

    const fmt = (n) => '$' + (parseFloat(n) || 0).toLocaleString('en-NZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const fmtDate = (d) => new Date(d).toLocaleDateString('en-NZ', { day: 'numeric', month: 'short' });
    const fmtDateFull = (d) => new Date(d).toLocaleDateString('en-NZ', { day: 'numeric', month: 'short', year: 'numeric' });

    // Receipt parsing
    const parseReceiptText = (text) => {
      const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
      const allText = lines.join(' ').toLowerCase();
      let total = 0, subtotal = 0, gst = 0, discount = 0, change = 0, tendered = 0;
      let vendor = '', date = null, time = null, category = 'misc', paymentMethod = '', cardLastFour = '';
      const items = [], amounts = [];

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i], lineLower = line.toLowerCase(), position = i / lines.length;
        const regex = /\$?\s*(\d{1,5})[.,](\d{2})\b/g;
        let match;
        while ((match = regex.exec(line)) !== null) {
          const amount = parseFloat(match[1] + '.' + match[2]);
          if (amount <= 0 || amount >= 100000) continue;
          amounts.push({
            amount, line: i, position, text: lineLower,
            isTotal: /\btotal\b/i.test(lineLower) && !/sub.?total|cash.?total|tendered|paid|change|rounding/i.test(lineLower),
            isGrandTotal: /grand\s*total/i.test(lineLower),
            isSubtotal: /sub.?total/i.test(lineLower),
            isGst: /\bgst\b/i.test(lineLower) && !/gst\s*(no|num|#|reg|inc)/i.test(lineLower),
            isTendered: /tender|tendered/i.test(lineLower),
            isCashPaid: /\bcash\b/i.test(lineLower) && !/cash\s*out|cash\s*back/i.test(lineLower) && position > 0.5,
            isChange: /\bchange\b/i.test(lineLower) && !/no\s*change/i.test(lineLower),
            isEftpos: /eftpos/i.test(lineLower),
            isVisa: /\bvisa\b/i.test(lineLower),
            isMastercard: /master/i.test(lineLower),
            isDiscount: /discount|saving|less|off|promo/i.test(lineLower),
          });
        }
      }

      const totalCandidates = amounts.filter(a => a.isGrandTotal || a.isTotal);
      const tenderedAmount = amounts.find(a => a.isTendered || a.isCashPaid);
      const changeAmount = amounts.find(a => a.isChange);
      const subtotalAmount = amounts.find(a => a.isSubtotal);
      const gstAmount = amounts.find(a => a.isGst);
      const cardPaymentAmount = amounts.find(a => (a.isEftpos || a.isVisa || a.isMastercard) && a.position > 0.5);

      if (tenderedAmount && changeAmount) {
        const calc = Math.round((tenderedAmount.amount - changeAmount.amount) * 100) / 100;
        if (calc > 0) { total = calc; tendered = tenderedAmount.amount; change = changeAmount.amount; }
      }
      if (total === 0 && totalCandidates.length > 0) {
        const sorted = totalCandidates.sort((a, b) => b.position - a.position);
        for (const c of sorted) {
          if (tenderedAmount && Math.abs(c.amount - tenderedAmount.amount) < 0.01) continue;
          total = c.amount; break;
        }
      }
      if (total === 0 && cardPaymentAmount && !changeAmount) total = cardPaymentAmount.amount;
      if (subtotalAmount) { subtotal = subtotalAmount.amount; if (gstAmount) gst = gstAmount.amount; }
      if (total === 0 && subtotal && gst) total = Math.round((subtotal + gst) * 100) / 100;
      if (total === 0) {
        const bottom = amounts.filter(a => a.position > 0.4 && !a.isDiscount && !a.isChange).sort((a, b) => b.amount - a.amount);
        if (bottom.length > 0) {
          if (changeAmount && bottom[0].amount > changeAmount.amount) total = bottom[0].amount - changeAmount.amount;
          else total = bottom[0].amount;
        }
      }
      if (total > 0 && !gst && !subtotal) { subtotal = Math.round((total / 1.15) * 100) / 100; gst = Math.round((total - subtotal) * 100) / 100; }

      const nzStores = {
        'countdown': { name: 'Countdown', category: 'kai' }, 'woolworths': { name: 'Countdown', category: 'kai' },
        'pak n save': { name: 'Pak n Save', category: 'kai' }, 'paknsave': { name: 'Pak n Save', category: 'kai' },
        'new world': { name: 'New World', category: 'kai' }, 'fresh choice': { name: 'Fresh Choice', category: 'kai' },
        'four square': { name: 'Four Square', category: 'kai' }, 'kfc': { name: 'KFC', category: 'catering' },
        'mcdonald': { name: 'McDonalds', category: 'catering' }, 'burger king': { name: 'Burger King', category: 'catering' },
        'subway': { name: 'Subway', category: 'catering' }, 'pizza hut': { name: 'Pizza Hut', category: 'catering' },
        'domino': { name: 'Dominos', category: 'catering' }, 'starbucks': { name: 'Starbucks', category: 'catering' },
        'super liquor': { name: 'Super Liquor', category: 'drinks' }, 'liquorland': { name: 'Liquorland', category: 'drinks' },
        'z energy': { name: 'Z Energy', category: 'petrol' }, 'bp ': { name: 'BP', category: 'petrol' },
        'mobil': { name: 'Mobil', category: 'petrol' }, 'gull': { name: 'Gull', category: 'petrol' },
        'caltex': { name: 'Caltex', category: 'petrol' }, 'kmart': { name: 'Kmart', category: 'clothing' },
        'farmers': { name: 'Farmers', category: 'clothing' }, 'the warehouse': { name: 'The Warehouse', category: 'clothing' },
        'warehouse stationery': { name: 'Warehouse Stationery', category: 'printing' },
        'florist': { name: 'Florist', category: 'flowers' }, 'flower': { name: 'Flower Shop', category: 'flowers' },
        'funeral': { name: 'Funeral Services', category: 'funeral_home' },
        'motel': { name: 'Motel', category: 'accommodation' }, 'hotel': { name: 'Hotel', category: 'accommodation' },
        'air new zealand': { name: 'Air New Zealand', category: 'flights' }, 'jetstar': { name: 'Jetstar', category: 'flights' },
      };

      const headerText = lines.slice(0, 10).join(' ').toLowerCase();
      for (const [pattern, info] of Object.entries(nzStores)) {
        if (headerText.includes(pattern)) { vendor = info.name; category = info.category; break; }
      }
      if (!vendor) {
        for (const [pattern, info] of Object.entries(nzStores)) {
          if (allText.includes(pattern)) { vendor = info.name; category = info.category; break; }
        }
      }

      if (category === 'misc') {
        if (/burger|pizza|chicken|coffee|cafe|restaurant|takeaway/i.test(allText)) category = 'catering';
        else if (/groceries|supermarket|fruit|vegetable/i.test(allText)) category = 'kai';
        else if (/wine|beer|vodka|liquor/i.test(allText)) category = 'drinks';
        else if (/petrol|diesel|fuel|litre/i.test(allText)) category = 'petrol';
        else if (/flower|floral|bouquet/i.test(allText)) category = 'flowers';
      }

      if (!vendor) {
        const skip = [/^\s*$/, /^[\d\s\-\.]+$/, /^tax\s*inv/i, /^receipt/i, /^eftpos/i, /^gst/i, /www\./i];
        for (const line of lines.slice(0, 8)) {
          const t = line.trim();
          if (t.length < 3 || t.length > 50) continue;
          if (skip.some(p => p.test(t))) continue;
          if ((t.match(/\d/g) || []).length > t.length * 0.5) continue;
          vendor = t; break;
        }
      }
      if (!vendor) vendor = 'Receipt';

      for (const line of lines) {
        const m = line.match(/(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})/);
        if (m) {
          let day = parseInt(m[1]), month = parseInt(m[2]), year = m[3].length === 2 ? 2000 + parseInt(m[3]) : parseInt(m[3]);
          if (month > 12 && day <= 12) [day, month] = [month, day];
          if (day >= 1 && day <= 31 && month >= 1 && month <= 12 && year >= 2020 && year <= 2030) {
            date = year + '-' + month.toString().padStart(2, '0') + '-' + day.toString().padStart(2, '0');
            break;
          }
        }
      }

      if (allText.includes('visa')) paymentMethod = 'Visa';
      else if (allText.includes('mastercard')) paymentMethod = 'Mastercard';
      else if (allText.includes('eftpos')) paymentMethod = 'EFTPOS';
      else if (tendered > 0 || allText.includes('cash')) paymentMethod = 'Cash';

      const cardMatch = allText.match(/[*xX]{4}\s*(\d{4})/);
      if (cardMatch) cardLastFour = cardMatch[1];

      console.log('Parsed:', total, vendor, category);
      return { total, vendor, date, time, category, items, subtotal, gst, discount, change, paymentMethod, cardLastFour };
    };

    // UI Components
    const PieChart = ({ data, size = 200, showLegend = true, title }) => {
      const total = data.reduce((a, d) => a + d.value, 0);
      if (total === 0) return null;
      let currentAngle = 0;
      const paths = data.filter(d => d.value > 0).map((d, i) => {
        const pct = d.value / total, angle = pct * 360;
        const startAngle = currentAngle; currentAngle += angle;
        const r = size / 2 - 10, cx = size / 2, cy = size / 2;
        const sr = (startAngle - 90) * Math.PI / 180, er = (currentAngle - 90) * Math.PI / 180;
        const x1 = cx + r * Math.cos(sr), y1 = cy + r * Math.sin(sr);
        const x2 = cx + r * Math.cos(er), y2 = cy + r * Math.sin(er);
        const la = angle > 180 ? 1 : 0;
        const pathD = pct === 1 ? `M ${cx} ${cy - r} A ${r} ${r} 0 1 1 ${cx - 0.01} ${cy - r} Z` : `M ${cx} ${cy} L ${x1} ${y1} A ${r} ${r} 0 ${la} 1 ${x2} ${y2} Z`;
        return <path key={i} d={pathD} fill={d.color} stroke="#0f172a" strokeWidth="2" />;
      });
      const totalStr = fmt(total);
      const fontSize = totalStr.length > 8 ? 12 : totalStr.length > 6 ? 14 : 18;
      return (
        <div className="flex flex-col items-center">
          {title && <p className="text-slate-400 text-sm font-medium mb-2">{title}</p>}
          <svg width={size} height={size} className="drop-shadow-lg">
            {paths}
            <circle cx={size/2} cy={size/2} r={size/4} fill="#0f172a" />
            <text x={size/2} y={size/2} textAnchor="middle" dy=".1em" fill="white" fontWeight="bold" style={{fontSize: fontSize + 'px'}}>{totalStr}</text>
            <text x={size/2} y={size/2 + 14} textAnchor="middle" fill="#94a3b8" style={{fontSize: '10px'}}>total</text>
          </svg>
          {showLegend && <div className="mt-3 space-y-1 w-full max-w-xs">
            {data.filter(d => d.value > 0).map((d, i) => (
              <div key={i} className="flex items-center justify-between text-sm">
                <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full" style={{backgroundColor: d.color}} /><span className="text-slate-300 truncate max-w-[100px]">{d.label}</span></div>
                <span className="text-slate-400 text-xs">{fmt(d.value)} ({((d.value/total)*100).toFixed(0)}%)</span>
              </div>
            ))}
          </div>}
        </div>
      );
    };

    const ProgressBar = ({ progress, status, details }) => (
      <div className="bg-slate-900 rounded-xl p-4 mb-4">
        <div className="flex justify-between items-center mb-2">
          <span className="text-sm text-white font-medium">{status}</span>
          <span className="text-sm text-cyan-400">{progress}%</span>
        </div>
        <div className="h-2 bg-slate-800 rounded-full overflow-hidden">
          <div className="h-full progress-animated rounded-full transition-all duration-300" style={{width: progress + '%'}} />
        </div>
        {details && <p className="text-slate-500 text-xs mt-2">{details}</p>}
      </div>
    );

    // Main App
    const App = () => {
      const [screen, setScreen] = useState(() => {
        const returnTo = sessionStorage.getItem('return_to_screen');
        if (returnTo) { sessionStorage.removeItem('return_to_screen'); return returnTo; }
        return 'home';
      });
      const [gifts, setGifts] = useState(() => S.get('gifts', []));
      const [expenses, setExpenses] = useState(() => S.get('expenses', []));
      const [transfers, setTransfers] = useState(() => S.get('transfers', []));
      const [editingItem, setEditingItem] = useState(null);
      const [syncCode, setSyncCode] = useState(() => S.get('syncCode', null));
      const [syncBinId, setSyncBinId] = useState(() => S.get('syncBinId', null));
      const [syncing, setSyncing] = useState(false);
      const [lastSync, setLastSync] = useState(() => S.get('lastSync', null));
      const [catLang, setCatLang] = useState(() => S.get('catLang', 'all'));
      const [validationResults, setValidationResults] = useState(() => S.get('validationResults', {}));
      const [giftValidationResults, setGiftValidationResults] = useState(() => S.get('giftValidationResults', {}));
      const [isValidating, setIsValidating] = useState(false);
      const [validationProgress, setValidationProgress] = useState(0);
      const [validationStatus, setValidationStatus] = useState('');

      const getCategoryById = (id) => EXPENSE_CATEGORIES.find(c => c.id === id) || EXPENSE_CATEGORIES[EXPENSE_CATEGORIES.length - 1];
      const getGiftCategoryById = (id) => GIFT_CATEGORIES.find(c => c.id === id) || GIFT_CATEGORIES[GIFT_CATEGORIES.length - 1];
      const getCategoryName = (cat) => catLang === 'all' ? `${cat.sm} ‚Ä¢ ${cat.mi} ‚Ä¢ ${cat.en}` : cat[catLang] || cat.en;

      useEffect(() => { S.set('gifts', gifts) }, [gifts]);
      useEffect(() => { S.set('expenses', expenses) }, [expenses]);
      useEffect(() => { S.set('transfers', transfers) }, [transfers]);
      useEffect(() => { S.set('syncCode', syncCode) }, [syncCode]);
      useEffect(() => { S.set('syncBinId', syncBinId) }, [syncBinId]);
      useEffect(() => { S.set('lastSync', lastSync) }, [lastSync]);
      useEffect(() => { S.set('catLang', catLang) }, [catLang]);
      useEffect(() => { S.set('validationResults', validationResults) }, [validationResults]);
      useEffect(() => { S.set('giftValidationResults', giftValidationResults) }, [giftValidationResults]);

      const initialSyncDone = useRef(false);
      useEffect(() => {
        if (syncBinId && !initialSyncDone.current) { initialSyncDone.current = true; syncFromCloud(); }
      }, [syncBinId]);

      useEffect(() => {
        if (!syncBinId) return;
        const handleSync = () => {
          if (syncBinId && !syncing) {
            const data = JSON.stringify({ gifts, expenses, transfers });
            navigator.sendBeacon?.('/api/sync?id=' + syncBinId, new Blob([data], { type: 'application/json' }));
          }
        };
        const handleVis = () => { if (document.visibilityState === 'hidden') handleSync(); };
        document.addEventListener('visibilitychange', handleVis);
        window.addEventListener('beforeunload', handleSync);
        return () => { document.removeEventListener('visibilitychange', handleVis); window.removeEventListener('beforeunload', handleSync); };
      }, [syncBinId, gifts, expenses, transfers, syncing]);

      const syncTimeout = useRef(null);
      const dataInit = useRef(false);
      useEffect(() => {
        if (!syncBinId) return;
        if (!dataInit.current) { dataInit.current = true; return; }
        if (syncTimeout.current) clearTimeout(syncTimeout.current);
        syncTimeout.current = setTimeout(() => syncToCloud(), 1000);
        return () => { if (syncTimeout.current) clearTimeout(syncTimeout.current); };
      }, [gifts, expenses, transfers, syncBinId]);

      // FIX: 30 second polling instead of 10
      useEffect(() => {
        if (!syncBinId) return;
        const poll = setInterval(() => { if (!syncing) syncFromCloud(); }, 30000);
        return () => clearInterval(poll);
      }, [syncBinId, syncing]);

      const syncToCloud = async () => {
        if (!syncBinId || syncing) return;
        setSyncing(true);
        const success = await CloudSync.update(syncBinId, { gifts, expenses, transfers });
        if (success) setLastSync(Date.now());
        setSyncing(false);
      };

      const syncFromCloud = async () => {
        if (!syncBinId || syncing) return;
        setSyncing(true);
        const data = await CloudSync.get(syncBinId);
        if (data) {
          const merge = (l, c) => { const m = new Map(); [...l, ...(c || [])].forEach(i => m.set(i.id, i)); return Array.from(m.values()); };
          setGifts(merge(gifts, data.gifts));
          setExpenses(merge(expenses, data.expenses));
          setTransfers(merge(transfers, data.transfers));
          setLastSync(Date.now());
        }
        setSyncing(false);
      };

      const createSync = async () => {
        setSyncing(true);
        const binId = await CloudSync.create({ gifts, expenses, transfers });
        if (binId && typeof binId === 'string') {
          setSyncCode(binId); setSyncBinId(binId); setLastSync(Date.now());
        }
        setSyncing(false);
        return binId;
      };

      const validateExpenses = async (toValidate = expenses, useAI = false) => {
        setIsValidating(true); setValidationProgress(0); setValidationStatus('Starting...');
        const results = { ...validationResults };
        const total = toValidate.length;
        for (let i = 0; i < total; i++) {
          const e = toValidate[i];
          if (results[e.id]?.dismissed) continue;
          const cat = getCategoryById(e.category);
          setValidationProgress(Math.round(((i + 1) / total) * 100));
          setValidationStatus('Checking ' + (i + 1) + '/' + total);
          const result = AIValidator.quickValidate(e, cat);
          results[e.id] = { ...result, validatedAt: Date.now(), originalCategory: e.category };
        }
        setValidationResults(results);
        setIsValidating(false); setValidationStatus('Done!');
        setTimeout(() => setValidationStatus(''), 2000);
      };

      const applySuggestion = (id, catId) => {
        setExpenses(p => p.map(e => e.id === id ? { ...e, category: catId } : e));
        setValidationResults(p => ({ ...p, [id]: { ...p[id], correct: true, applied: true } }));
      };
      const dismissSuggestion = (id) => setValidationResults(p => ({ ...p, [id]: { ...p[id], correct: true, dismissed: true } }));
      const applyGiftSuggestion = (id, catId) => {
        setGifts(p => p.map(g => g.id === id ? { ...g, category: catId } : g));
        setGiftValidationResults(p => ({ ...p, [id]: { ...p[id], correct: true, applied: true } }));
      };
      const dismissGiftSuggestion = (id) => setGiftValidationResults(p => ({ ...p, [id]: { ...p[id], correct: true, dismissed: true } }));

      const totals = useMemo(() => {
        const gc = gifts.filter(g => g.method === 'cash').reduce((a, g) => a + g.amount, 0);
        const gb = gifts.filter(g => g.method === 'bank').reduce((a, g) => a + g.amount, 0);
        const ec = expenses.filter(e => e.method === 'cash').reduce((a, e) => a + e.amount, 0);
        const eb = expenses.filter(e => e.method === 'bank').reduce((a, e) => a + e.amount, 0);
        const tr = transfers.reduce((a, t) => a + t.amount, 0);
        return { giftsTotal: gc + gb, giftsCash: gc, giftsBank: gb, expensesTotal: ec + eb, expensesCash: ec, expensesBank: eb, transferredToBank: tr, balanceCash: gc - ec - tr, balanceBank: gb - eb + tr, balanceTotal: (gc + gb) - (ec + eb) };
      }, [gifts, expenses, transfers]);

      const donors = useMemo(() => [...new Set(gifts.map(g => g.donor))].sort(), [gifts]);
      const flaggedExpenses = useMemo(() => expenses.filter(e => { const r = validationResults[e.id]; return r && !r.correct && !r.dismissed && !r.applied; }), [expenses, validationResults]);
      const flaggedGifts = useMemo(() => gifts.filter(g => { const r = giftValidationResults[g.id]; return r && !r.correct && !r.dismissed && !r.applied; }), [gifts, giftValidationResults]);

      const addGift = (g) => setGifts(p => [...p, { ...g, id: Date.now(), createdAt: new Date().toISOString() }]);
      const addExpense = (e) => setExpenses(p => [...p, { ...e, id: Date.now(), createdAt: new Date().toISOString() }]);
      const addTransfer = (t) => setTransfers(p => [...p, { ...t, id: Date.now(), createdAt: new Date().toISOString() }]);
      const deleteGift = (id) => setGifts(p => p.filter(g => g.id !== id));
      const deleteExpense = (id) => setExpenses(p => p.filter(e => e.id !== id));
      const deleteTransfer = (id) => setTransfers(p => p.filter(t => t.id !== id));
      const updateGift = (id, u) => setGifts(p => p.map(g => g.id === id ? { ...g, ...u } : g));
      const updateExpense = (id, u) => setExpenses(p => p.map(e => e.id === id ? { ...e, ...u } : e));

      const CatLangSelector = ({ showLabel = true }) => {
        const [show, setShow] = useState(false);
        const opts = [{ code: 'all', label: 'All', short: 'üåè' }, { code: 'sm', label: 'Samoa', short: 'üáºüá∏' }, { code: 'mi', label: 'MƒÅori', short: 'üá≥üáø' }, { code: 'en', label: 'English', short: 'üá¨üáß' }];
        const cur = opts.find(o => o.code === catLang);
        return (
          <div className="relative">
            <button onClick={() => setShow(!show)} className="flex items-center gap-1 px-2 py-1 bg-slate-800 rounded-lg text-xs">
              <span>{cur?.short}</span>{showLabel && <span className="text-slate-400 uppercase">{catLang === 'all' ? 'ALL' : catLang}</span>}
            </button>
            {show && <>
              <div className="fixed inset-0 z-40" onClick={() => setShow(false)} />
              <div className="absolute right-0 top-full mt-1 bg-slate-800 rounded-xl overflow-hidden z-50 border border-slate-700 min-w-[140px]">
                {opts.map(o => <button key={o.code} onClick={() => { setCatLang(o.code); setShow(false); }} className={`w-full px-4 py-3 text-left flex items-center gap-3 ${catLang === o.code ? 'bg-cyan-600' : 'hover:bg-slate-700'}`}><span>{o.short}</span><span className="text-white text-sm">{o.label}</span></button>)}
              </div>
            </>}
          </div>
        );
      };

      const Nav = () => (
        <div className="fixed bottom-0 left-0 right-0 bg-slate-900/95 backdrop-blur border-t border-slate-800 px-4 py-2 pb-6">
          <div className="flex justify-around max-w-md mx-auto">
            {[{ id: 'home', icon: 'üè†', label: 'Fale' }, { id: 'gifts', icon: 'üéÅ', label: 'Koha' }, { id: 'expenses', icon: 'üí∏', label: 'Tau' }, { id: 'analytics', icon: 'üìä', label: 'Aotelega' }].map(n => (
              <button key={n.id} onClick={() => setScreen(n.id)} className={`flex flex-col items-center gap-1 px-4 py-1 rounded-xl relative ${screen === n.id || (n.id === 'gifts' && ['addGift', 'editGift'].includes(screen)) || (n.id === 'expenses' && ['addExpense', 'editExpense', 'addTransfer'].includes(screen)) ? 'text-cyan-400' : 'text-slate-500'}`}>
                <span className="text-xl">{n.icon}</span><span className="text-xs">{n.label}</span>
                {n.id === 'analytics' && (flaggedExpenses.length + flaggedGifts.length) > 0 && <span className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full text-xs text-white flex items-center justify-center">{flaggedExpenses.length + flaggedGifts.length}</span>}
              </button>
            ))}
          </div>
        </div>
      );

      // Home Screen
      const Home = () => {
        const recent = useMemo(() => {
          const all = [...gifts.map(g => ({ ...g, type: 'gift' })), ...expenses.map(e => ({ ...e, type: 'expense' })), ...transfers.map(t => ({ ...t, type: 'transfer' }))];
          return all.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 5);
        }, [gifts, expenses, transfers]);

        return (
          <div className="min-h-screen bg-slate-950 text-white pb-24">
            <div className="px-5 pt-8">
              <div className="flex justify-between items-start mb-4">
                <div><p className="text-slate-500 text-sm">ƒÄiga ‚Ä¢ WhƒÅnau ‚Ä¢ Family</p><h1 className="text-2xl font-bold">Meaalofa ‚Ä¢ Koha Tracker</h1></div>
                <button onClick={() => setScreen('sync')} className="flex items-center gap-2 px-3 py-1.5 bg-slate-800 rounded-lg text-sm">
                  {syncing ? <span className="spin">üîÑ</span> : syncBinId ? <span className="text-green-400">‚òÅÔ∏è</span> : <span className="text-slate-500">‚òÅÔ∏è</span>}
                  <span className="text-slate-400">{syncBinId || 'Sync'}</span>
                </button>
              </div>

              {(isValidating || validationStatus) && <ProgressBar progress={validationProgress} status={validationStatus} />}

              {(flaggedExpenses.length > 0 || flaggedGifts.length > 0) && !isValidating && (
                <button onClick={() => setScreen('analytics')} className="w-full bg-amber-900/30 border border-amber-700/50 rounded-xl p-3 mb-4 flex items-center justify-between">
                  <div className="flex items-center gap-2"><span className="text-amber-400">‚ö†Ô∏è</span><span className="text-amber-200 text-sm">{flaggedExpenses.length + flaggedGifts.length} items may need review</span></div>
                  <span className="text-amber-400 text-sm">View ‚Üí</span>
                </button>
              )}

              <div className="bg-gradient-to-br from-cyan-600 to-teal-600 rounded-2xl p-5 mb-4">
                <p className="text-cyan-100 text-sm mb-1">Tupe Totoe ‚Ä¢ Balance</p>
                <p className={`text-4xl font-bold ${totals.balanceTotal < 0 ? 'text-red-200' : 'text-white'}`}>{fmt(totals.balanceTotal)}</p>
                <div className="flex gap-6 mt-4">
                  <div><p className="text-cyan-100 text-xs">Cash</p><p className={`text-lg font-semibold ${totals.balanceCash < 0 ? 'text-red-200' : 'text-white'}`}>{fmt(totals.balanceCash)}</p></div>
                  <div><p className="text-cyan-100 text-xs">Bank</p><p className={`text-lg font-semibold ${totals.balanceBank < 0 ? 'text-red-200' : 'text-white'}`}>{fmt(totals.balanceBank)}</p></div>
                </div>
                {totals.balanceCash > 0 && <button onClick={() => setScreen('addTransfer')} className="mt-4 w-full py-2 bg-white/20 rounded-xl text-sm font-medium">üíµ ‚Üí üè¶ Deposit Cash</button>}
              </div>

              <div className="grid grid-cols-2 gap-3 mb-6">
                <div className="bg-slate-900 rounded-xl p-4"><div className="flex items-center gap-2 mb-1"><span className="text-green-400">‚Üì</span><span className="text-slate-400 text-sm">In</span></div><p className="text-2xl font-bold text-green-400">{fmt(totals.giftsTotal)}</p><p className="text-slate-500 text-xs mt-1">{gifts.length} koha</p></div>
                <div className="bg-slate-900 rounded-xl p-4"><div className="flex items-center gap-2 mb-1"><span className="text-red-400">‚Üë</span><span className="text-slate-400 text-sm">Out</span></div><p className="text-2xl font-bold text-red-400">{fmt(totals.expensesTotal)}</p><p className="text-slate-500 text-xs mt-1">{expenses.length} expenses</p></div>
              </div>

              <div className="grid grid-cols-2 gap-3 mb-6">
                <button onClick={() => setScreen('addGift')} className="bg-gradient-to-br from-green-600 to-emerald-600 rounded-xl p-4 text-left active:scale-95 transition-transform"><span className="text-2xl">üéÅ</span><p className="font-bold mt-2">Add Koha</p></button>
                <button onClick={() => setScreen('addExpense')} className="bg-gradient-to-br from-orange-600 to-red-600 rounded-xl p-4 text-left active:scale-95 transition-transform"><span className="text-2xl">üí∏</span><p className="font-bold mt-2">Add Expense</p></button>
              </div>

              {recent.length > 0 && <div>
                <p className="text-slate-400 text-sm font-medium mb-3">RECENT</p>
                <div className="space-y-2">
                  {recent.map(tx => {
                    const gCat = tx.type === 'gift' ? getGiftCategoryById(tx.category) : null;
                    return (
                      <div key={tx.id} onClick={() => { if (tx.type !== 'transfer') { setEditingItem(tx); setScreen(tx.type === 'gift' ? 'editGift' : 'editExpense'); }}} className={`bg-slate-900 rounded-xl p-3 flex items-center gap-3 ${tx.type !== 'transfer' ? 'active:bg-slate-800' : ''}`}>
                        <div className="w-10 h-10 rounded-full flex items-center justify-center" style={tx.type === 'gift' && gCat ? { backgroundColor: gCat.color + '30' } : { backgroundColor: '#1e293b' }}>
                          <span>{tx.type === 'gift' ? (gCat?.icon || 'üéÅ') : tx.type === 'transfer' ? 'üè¶' : getCategoryById(tx.category).icon}</span>
                        </div>
                        <div className="flex-1"><p className="font-medium text-white">{tx.type === 'gift' ? tx.donor : tx.type === 'transfer' ? 'Cash ‚Üí Bank' : tx.description || getCategoryName(getCategoryById(tx.category))}</p><p className="text-slate-500 text-xs">{fmtDate(tx.date)} ‚Ä¢ {tx.method === 'cash' ? 'üíµ' : 'üè¶'}</p></div>
                        <p className={`font-bold ${tx.type === 'gift' ? 'text-green-400' : tx.type === 'transfer' ? 'text-blue-400' : 'text-red-400'}`}>{tx.type === 'gift' ? '+' : tx.type === 'transfer' ? '' : '-'}{fmt(tx.amount)}</p>
                      </div>
                    );
                  })}
                </div>
              </div>}
            </div>
            <Nav />
          </div>
        );
      };

      // Sync Screen
      const SyncScreen = () => {
        const [joinCode, setJoinCode] = useState('');
        const [copied, setCopied] = useState(false);
        const [error, setError] = useState('');
        const [status, setStatus] = useState('');
        const [creating, setCreating] = useState(false);

        const handleCreate = async () => {
          setError(''); setStatus('Creating...'); setCreating(true);
          const result = await CloudSync.create({ gifts, expenses, transfers });
          if (result && typeof result === 'string') {
            setSyncCode(result); setSyncBinId(result); setLastSync(Date.now()); setStatus('Created!');
          } else setError('Failed: ' + (result?.error || 'unknown'));
          setCreating(false);
        };

        const handleJoin = async () => {
          const code = joinCode.trim().toUpperCase();
          if (code.length < 4) { alert('Enter valid code'); return; }
          setSyncing(true);
          const data = await CloudSync.get(code);
          setSyncing(false);
          if (data) {
            setSyncCode(code); setSyncBinId(code);
            const merge = (l, c) => { const m = new Map(); [...l, ...(c || [])].forEach(i => m.set(i.id, i)); return Array.from(m.values()); };
            setGifts(merge(gifts, data.gifts)); setExpenses(merge(expenses, data.expenses)); setTransfers(merge(transfers, data.transfers));
            setLastSync(Date.now()); alert('Connected!'); setJoinCode('');
          } else alert('Code not found');
        };

        const copyCode = async () => { const ok = await copyToClipboard(syncBinId); if (ok) { setCopied(true); setTimeout(() => setCopied(false), 2000); } };

        return (
          <div className="min-h-screen bg-slate-950 text-white pb-24">
            <div className="px-5 pt-8">
              <button onClick={() => setScreen('home')} className="text-slate-500 text-sm mb-4">‚Üê Back</button>
              <h1 className="text-2xl font-bold mb-2">Sync</h1>
              <p className="text-slate-500 text-sm mb-6">Share with whƒÅnau</p>

              {error && <div className="bg-red-900/30 border border-red-700/50 rounded-xl p-3 mb-4"><p className="text-red-300 text-sm">{error}</p></div>}
              {status && <div className="bg-cyan-900/30 border border-cyan-700/50 rounded-xl p-3 mb-4"><p className="text-cyan-300 text-sm">{status}</p></div>}

              <div className={`rounded-xl p-4 mb-6 ${syncBinId ? 'bg-green-900/30 border border-green-700/50' : 'bg-slate-900'}`}>
                <div className="flex items-center gap-3">
                  <span className="text-2xl">{syncBinId ? '‚òÅÔ∏è' : 'üì¥'}</span>
                  <div><p className="font-medium">{syncBinId ? 'Sync Active' : 'Not Connected'}</p>{syncBinId ? <p className="text-green-400 text-xl font-bold tracking-widest">{syncBinId}</p> : <p className="text-slate-500 text-sm">Create or join</p>}</div>
                </div>
              </div>

              {syncBinId ? <>
                <button onClick={copyCode} className="w-full py-3 bg-cyan-600 rounded-xl font-medium mb-3">{copied ? '‚úì Copied!' : 'üìã Copy Code'}</button>
                <button onClick={syncFromCloud} disabled={syncing} className="w-full py-3 bg-slate-800 rounded-xl font-medium mb-3">{syncing ? 'üîÑ Syncing...' : 'üîÑ Sync Now'}</button>
                <button onClick={() => { if (confirm('Leave sync?')) { setSyncCode(null); setSyncBinId(null); }}} className="w-full py-3 bg-red-900/30 rounded-xl text-red-400 text-sm">Leave Sync</button>
              </> : <>
                <div className="bg-slate-900 rounded-xl p-4 mb-4">
                  <button onClick={handleCreate} disabled={creating} className="w-full py-3 bg-gradient-to-r from-cyan-600 to-teal-600 rounded-xl font-bold disabled:opacity-50 mb-3">{creating ? 'üîÑ Creating...' : '+ Create Family Sync'}</button>
                  <div className="border-t border-slate-800 pt-3 mt-3">
                    <p className="text-slate-400 text-xs mb-2">Or join existing:</p>
                    <input type="text" value={joinCode} onChange={(e) => setJoinCode(e.target.value.toUpperCase().slice(0, 5))} placeholder="Enter code" className="w-full bg-slate-800 rounded-xl px-4 py-3 text-white mb-2 text-center tracking-widest font-bold uppercase" maxLength={5} />
                    <button onClick={handleJoin} disabled={!joinCode.trim() || syncing} className="w-full py-2 bg-slate-700 rounded-xl font-medium disabled:opacity-50">{syncing ? 'üîÑ...' : 'Join'}</button>
                  </div>
                </div>
              </>}

              {lastSync && <p className="text-slate-600 text-xs text-center mt-6">Last sync: {new Date(lastSync).toLocaleString()}</p>}
            </div>
            <Nav />
          </div>
        );
      };

      // Add Transfer
      const AddTransfer = () => {
        const [amount, setAmount] = useState('');
        const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
        const [note, setNote] = useState('');
        const submit = () => { if (!amount || parseFloat(amount) <= 0 || parseFloat(amount) > totals.balanceCash) return; addTransfer({ amount: parseFloat(amount), date, note: note.trim() }); setScreen('home'); };
        return (
          <div className="min-h-screen bg-slate-950 text-white pb-24">
            <div className="px-5 pt-8">
              <button onClick={() => setScreen('home')} className="text-slate-500 text-sm mb-4">‚Üê Back</button>
              <h1 className="text-2xl font-bold mb-6">üíµ ‚Üí üè¶ Deposit Cash</h1>
              <div className="bg-slate-900 rounded-xl p-4 mb-6"><p className="text-slate-400 text-sm">Cash Available</p><p className="text-2xl font-bold text-green-400">{fmt(totals.balanceCash)}</p></div>
              <div className="mb-4"><label className="text-slate-400 text-sm mb-2 block">Amount</label><div className="relative"><span className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xl">$</span><input type="number" value={amount} onChange={(e) => setAmount(e.target.value)} placeholder="0.00" className="w-full bg-slate-900 rounded-xl px-4 py-4 pl-10 text-2xl font-bold text-white placeholder-slate-600 outline-none" /></div><button onClick={() => setAmount(totals.balanceCash.toString())} className="mt-2 text-cyan-400 text-sm">All ({fmt(totals.balanceCash)})</button></div>
              <div className="mb-4"><label className="text-slate-400 text-sm mb-2 block">Date</label><input type="date" value={date} onChange={(e) => setDate(e.target.value)} className="w-full bg-slate-900 rounded-xl px-4 py-3 text-white" /></div>
              <div className="mb-6"><label className="text-slate-400 text-sm mb-2 block">Note</label><input type="text" value={note} onChange={(e) => setNote(e.target.value)} placeholder="(optional)" className="w-full bg-slate-900 rounded-xl px-4 py-3 text-white placeholder-slate-600" /></div>
              <button onClick={submit} disabled={!amount || parseFloat(amount) <= 0 || parseFloat(amount) > totals.balanceCash} className="w-full py-4 bg-gradient-to-r from-blue-600 to-cyan-600 rounded-xl font-bold text-lg disabled:opacity-50">Deposit</button>
            </div>
            <Nav />
          </div>
        );
      };

      // Add Gift Screen
      const AddGift = ({ editing = false }) => {
        const [amount, setAmount] = useState(editing && editingItem ? editingItem.amount.toString() : '');
        const [donor, setDonor] = useState(editing && editingItem ? editingItem.donor : '');
        const [category, setCategory] = useState(editing && editingItem ? editingItem.category || '' : '');
        const [method, setMethod] = useState(editing && editingItem ? editingItem.method : 'cash');
        const [note, setNote] = useState(editing && editingItem ? editingItem.note || '' : '');
        const [date, setDate] = useState(editing && editingItem ? editingItem.date : new Date().toISOString().split('T')[0]);
        const [showSugg, setShowSugg] = useState(false);
        const [showCats, setShowCats] = useState(false);
        const [confirmDel, setConfirmDel] = useState(false);
        const [aiSugg, setAiSugg] = useState(null);

        const filtered = useMemo(() => donor.trim() ? donors.filter(d => d.toLowerCase().includes(donor.toLowerCase()) && d.toLowerCase() !== donor.toLowerCase()) : [], [donor, donors]);

        useEffect(() => {
          if (donor.trim().length > 2) {
            const s = AIValidator.suggestGiftCategory(donor, gifts);
            setAiSugg(s);
            if (s && !category && s.confidence >= 75) setCategory(s.categoryId);
          } else setAiSugg(null);
        }, [donor, gifts]);

        const submit = () => { if (!amount || !donor.trim()) return; const data = { amount: parseFloat(amount), donor: donor.trim(), category: category || 'isi', method, note: note.trim(), date }; if (editing && editingItem) updateGift(editingItem.id, data); else addGift(data); setScreen('gifts'); setEditingItem(null); };
        const handleDel = () => { if (confirmDel) { deleteGift(editingItem.id); setScreen('gifts'); setEditingItem(null); } else { setConfirmDel(true); setTimeout(() => setConfirmDel(false), 3000); }};
        const selCat = category ? getGiftCategoryById(category) : null;

        return (
          <div className="min-h-screen bg-slate-950 text-white pb-24">
            <div className="px-5 pt-8">
              <button onClick={() => { setScreen(editing ? 'gifts' : 'home'); setEditingItem(null); }} className="text-slate-500 text-sm mb-4">‚Üê Back</button>
              <h1 className="text-2xl font-bold mb-6">{editing ? "Edit Gift" : "Add Gift"}</h1>
              <div className="mb-4"><label className="text-slate-400 text-sm mb-2 block">Amount</label><div className="relative"><span className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xl">$</span><input type="number" value={amount} onChange={(e) => setAmount(e.target.value)} placeholder="0.00" className="w-full bg-slate-900 rounded-xl px-4 py-4 pl-10 text-2xl font-bold text-white placeholder-slate-600 outline-none" /></div></div>
              <div className="mb-4 relative"><label className="text-slate-400 text-sm mb-2 block">From</label><input type="text" value={donor} onChange={(e) => { setDonor(e.target.value); setShowSugg(true); }} onFocus={() => setShowSugg(true)} onBlur={() => setTimeout(() => setShowSugg(false), 200)} placeholder="Name" className="w-full bg-slate-900 rounded-xl px-4 py-3 text-white placeholder-slate-600 outline-none" />{showSugg && filtered.length > 0 && <div className="absolute top-full left-0 right-0 mt-1 bg-slate-800 rounded-xl overflow-hidden z-10 border border-slate-700">{filtered.slice(0, 5).map(d => <button key={d} onClick={() => { setDonor(d); setShowSugg(false); }} className="w-full px-4 py-3 text-left text-white hover:bg-slate-700">{d}</button>)}</div>}</div>
              {aiSugg && !category && <div className="mb-4 bg-cyan-900/30 border border-cyan-700/50 rounded-xl p-3"><div className="flex items-center justify-between"><span className="text-cyan-200 text-sm">ü§ñ Looks like {aiSugg.category.en}?</span><button onClick={() => setCategory(aiSugg.categoryId)} className="px-3 py-1 bg-cyan-600 rounded-lg text-sm font-medium">{aiSugg.category.icon} Yes</button></div></div>}
              <div className="mb-4"><label className="text-slate-400 text-sm mb-2 block">Category</label><button onClick={() => setShowCats(true)} className="w-full bg-slate-900 rounded-xl px-4 py-3 text-left flex items-center gap-3">{selCat ? <><span className="text-xl">{selCat.icon}</span><span className="text-white">{getCategoryName(selCat)}</span></> : <span className="text-slate-600">Select (optional)</span>}</button></div>
              {showCats && <div className="fixed inset-0 z-50 flex items-center justify-center p-4" onClick={() => setShowCats(false)}><div className="absolute inset-0 bg-slate-950/80 backdrop-blur-sm fade-in" /><div className="relative bg-slate-900 w-full max-w-sm rounded-2xl p-5 border border-slate-700 slide-in" onClick={(e) => e.stopPropagation()}><div className="flex justify-between items-center mb-4"><h2 className="text-lg font-bold text-white">Select Category</h2><button onClick={() => setShowCats(false)} className="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center text-slate-400">√ó</button></div><div className="grid grid-cols-2 gap-2">{GIFT_CATEGORIES.map(cat => <button key={cat.id} onClick={() => { setCategory(cat.id); setShowCats(false); }} className={`p-4 rounded-xl flex flex-col items-center gap-2 ${category === cat.id ? 'ring-2 ring-cyan-400' : ''}`} style={{ backgroundColor: cat.color + '20' }}><span className="text-2xl">{cat.icon}</span><span className="text-xs text-white text-center">{getCategoryName(cat)}</span></button>)}</div>{category && <button onClick={() => { setCategory(''); setShowCats(false); }} className="w-full mt-4 py-2 bg-slate-800 rounded-xl text-slate-400 text-sm">Clear</button>}</div></div>}
              <div className="mb-4"><label className="text-slate-400 text-sm mb-2 block">Method</label><div className="grid grid-cols-2 gap-2"><button onClick={() => setMethod('cash')} className={`py-3 rounded-xl font-medium ${method === 'cash' ? 'bg-green-600 text-white' : 'bg-slate-900 text-slate-400'}`}>üíµ Cash</button><button onClick={() => setMethod('bank')} className={`py-3 rounded-xl font-medium ${method === 'bank' ? 'bg-blue-600 text-white' : 'bg-slate-900 text-slate-400'}`}>üè¶ Bank</button></div></div>
              <div className="mb-4"><label className="text-slate-400 text-sm mb-2 block">Date</label><input type="date" value={date} onChange={(e) => setDate(e.target.value)} className="w-full bg-slate-900 rounded-xl px-4 py-3 text-white" /></div>
              <div className="mb-6"><label className="text-slate-400 text-sm mb-2 block">Note</label><input type="text" value={note} onChange={(e) => setNote(e.target.value)} placeholder="(optional)" className="w-full bg-slate-900 rounded-xl px-4 py-3 text-white placeholder-slate-600" /></div>
              <button onClick={submit} disabled={!amount || !donor.trim()} className="w-full py-4 bg-gradient-to-r from-green-600 to-emerald-600 rounded-xl font-bold text-lg disabled:opacity-50">{editing ? "Save" : "Add"}</button>
              {editing && <button onClick={handleDel} className={`w-full py-3 mt-3 rounded-xl font-medium ${confirmDel ? 'bg-red-600 text-white' : 'bg-slate-900 text-red-400'}`}>{confirmDel ? 'Tap to confirm' : 'Delete'}</button>}
            </div>
            <Nav />
          </div>
        );
      };

      // Gifts List
      const Gifts = () => {
        const [filter, setFilter] = useState('all');
        const [search, setSearch] = useState('');
        const [catFilter, setCatFilter] = useState('all');
        const filtered = useMemo(() => {
          let r = [...gifts];
          if (filter === 'cash' || filter === 'bank') r = r.filter(g => g.method === filter);
          if (catFilter !== 'all') r = r.filter(g => g.category === catFilter);
          if (search.trim()) r = r.filter(g => g.donor.toLowerCase().includes(search.toLowerCase()));
          return r.sort((a, b) => new Date(b.date) - new Date(a.date));
        }, [gifts, filter, catFilter, search]);
        const catCounts = useMemo(() => { const c = {}; gifts.forEach(g => { c[g.category || 'isi'] = (c[g.category || 'isi'] || 0) + 1; }); return c; }, [gifts]);

        return (
          <div className="min-h-screen bg-slate-950 text-white pb-24">
            <div className="px-5 pt-8">
              <div className="flex justify-between items-start mb-4"><div><h1 className="text-2xl font-bold">Koha</h1><p className="text-slate-500 text-sm">{gifts.length} total: {fmt(totals.giftsTotal)}</p></div><button onClick={() => setScreen('addGift')} className="w-10 h-10 bg-green-600 rounded-full flex items-center justify-center text-xl">+</button></div>
              <input type="text" value={search} onChange={(e) => setSearch(e.target.value)} placeholder="Search..." className="w-full bg-slate-900 rounded-xl px-4 py-3 text-white placeholder-slate-600 outline-none mb-4" />
              <div className="flex gap-2 mb-3">{[{ id: 'all', label: 'All' }, { id: 'cash', label: 'üíµ' }, { id: 'bank', label: 'üè¶' }].map(f => <button key={f.id} onClick={() => setFilter(f.id)} className={`px-4 py-2 rounded-lg text-sm font-medium ${filter === f.id ? 'bg-cyan-600 text-white' : 'bg-slate-900 text-slate-400'}`}>{f.label}</button>)}</div>
              <div className="flex gap-2 mb-4 overflow-x-auto pb-2"><button onClick={() => setCatFilter('all')} className={`px-3 py-1.5 rounded-lg text-sm font-medium whitespace-nowrap ${catFilter === 'all' ? 'bg-green-600 text-white' : 'bg-slate-900 text-slate-400'}`}>All</button>{GIFT_CATEGORIES.map(cat => <button key={cat.id} onClick={() => setCatFilter(cat.id)} className={`px-3 py-1.5 rounded-lg text-sm font-medium whitespace-nowrap flex items-center gap-1 ${catFilter === cat.id ? 'text-white' : 'bg-slate-900 text-slate-400'}`} style={catFilter === cat.id ? { backgroundColor: cat.color } : {}}>{cat.icon} {catCounts[cat.id] || 0}</button>)}</div>
              <div className="space-y-2">{filtered.map(g => { const cat = getGiftCategoryById(g.category); return <div key={g.id} onClick={() => { setEditingItem(g); setScreen('editGift'); }} className="bg-slate-900 rounded-xl p-4 active:bg-slate-800"><div className="flex items-start gap-3"><div className="w-10 h-10 rounded-full flex items-center justify-center text-lg" style={{ backgroundColor: cat.color + '30' }}>{cat.icon}</div><div className="flex-1"><p className="font-medium text-white">{g.donor}</p><p className="text-slate-500 text-sm">{fmtDateFull(g.date)} ‚Ä¢ {g.method === 'cash' ? 'üíµ' : 'üè¶'}</p></div><p className="text-green-400 font-bold text-lg">{fmt(g.amount)}</p></div></div>; })}</div>
              {filtered.length === 0 && <div className="text-center py-12"><span className="text-4xl mb-4 block">üéÅ</span><p className="text-slate-400">No gifts yet</p></div>}
            </div>
            <Nav />
          </div>
        );
      };

      // Expenses List
      const Expenses = () => {
        const [filter, setFilter] = useState('all');
        const [search, setSearch] = useState('');
        const [showTr, setShowTr] = useState(false);
        const filtered = useMemo(() => {
          let r = [...expenses];
          if (filter === 'cash' || filter === 'bank') r = r.filter(e => e.method === filter);
          if (filter === 'receipts') r = r.filter(e => !!e.receipt);
          if (search.trim()) r = r.filter(e => e.description?.toLowerCase().includes(search.toLowerCase()) || getCategoryById(e.category).en.toLowerCase().includes(search.toLowerCase()));
          return r.sort((a, b) => new Date(b.date) - new Date(a.date));
        }, [expenses, filter, search]);
        const receiptCount = useMemo(() => expenses.filter(e => !!e.receipt).length, [expenses]);

        return (
          <div className="min-h-screen bg-slate-950 text-white pb-24">
            <div className="px-5 pt-8">
              <div className="flex justify-between items-start mb-4"><div><h1 className="text-2xl font-bold">Expenses</h1><p className="text-slate-500 text-sm">{expenses.length} total: {fmt(totals.expensesTotal)}</p></div><div className="flex gap-2"><CatLangSelector showLabel={false} /><button onClick={() => setScreen('addExpense')} className="w-10 h-10 bg-orange-600 rounded-full flex items-center justify-center text-xl">+</button></div></div>
              <input type="text" value={search} onChange={(e) => setSearch(e.target.value)} placeholder="Search..." className="w-full bg-slate-900 rounded-xl px-4 py-3 text-white placeholder-slate-600 outline-none mb-4" />
              <div className="flex gap-2 mb-4 overflow-x-auto pb-2">{[{ id: 'all', label: 'All' }, { id: 'cash', label: 'üíµ' }, { id: 'bank', label: 'üè¶' }, { id: 'receipts', label: 'üßæ ' + receiptCount }].map(f => <button key={f.id} onClick={() => setFilter(f.id)} className={`px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap ${filter === f.id ? 'bg-cyan-600 text-white' : 'bg-slate-900 text-slate-400'}`}>{f.label}</button>)}</div>
              {transfers.length > 0 && <div className="mb-4"><button onClick={() => setShowTr(!showTr)} className="w-full bg-blue-900/30 border border-blue-700/50 rounded-xl p-3 flex justify-between items-center"><span className="text-blue-400 text-sm">üíµ‚Üíüè¶ Deposits ({transfers.length})</span><span className="text-blue-400 font-medium">{fmt(totals.transferredToBank)}</span></button>{showTr && <div className="mt-2 space-y-2">{transfers.sort((a, b) => new Date(b.date) - new Date(a.date)).map(t => <div key={t.id} className="bg-slate-900 rounded-xl p-3 flex justify-between items-center"><div><p className="text-white text-sm">{fmtDateFull(t.date)}</p>{t.note && <p className="text-slate-500 text-xs">{t.note}</p>}</div><div className="flex items-center gap-2"><p className="text-blue-400 font-medium">{fmt(t.amount)}</p><button onClick={() => { if (confirm('Delete?')) deleteTransfer(t.id); }} className="text-red-400 text-xs px-2 py-1 bg-red-900/30 rounded">‚úï</button></div></div>)}</div>}</div>}
              <div className="space-y-2">{filtered.map(e => { const cat = getCategoryById(e.category); const r = validationResults[e.id]; const flagged = r && !r.correct && !r.dismissed && !r.applied; const hasReceipt = !!e.receipt; return <div key={e.id} onClick={() => { setEditingItem(e); setScreen('editExpense'); }} className={`bg-slate-900 rounded-xl p-4 active:bg-slate-800 ${flagged ? 'border border-amber-500/50' : ''}`}><div className="flex items-start gap-3"><div className="w-10 h-10 bg-slate-800 rounded-full flex items-center justify-center relative"><span>{cat.icon}</span>{hasReceipt && <span className="absolute -bottom-1 -right-1 w-5 h-5 bg-purple-600 rounded-full flex items-center justify-center text-xs">üßæ</span>}</div><div className="flex-1"><p className="font-medium text-white">{e.description || getCategoryName(cat)}</p><p className="text-slate-500 text-sm">{fmtDateFull(e.date)} ‚Ä¢ {e.method === 'cash' ? 'üíµ' : 'üè¶'}</p></div><div className="text-right"><p className="text-red-400 font-bold text-lg">{fmt(e.amount)}</p>{flagged && <span className="text-amber-400 text-xs">‚ö†Ô∏è</span>}</div></div></div>; })}</div>
              {filtered.length === 0 && <div className="text-center py-12"><span className="text-4xl mb-4 block">üí∏</span><p className="text-slate-400">No expenses yet</p></div>}
            </div>
            <Nav />
          </div>
        );
      };

      // Add Expense - FIXED camera handling
      const AddExpense = ({ editing = false }) => {
        const [amount, setAmount] = useState(editing && editingItem ? editingItem.amount.toString() : '');
        const [description, setDescription] = useState(editing && editingItem ? editingItem.description || '' : '');
        const [category, setCategory] = useState(editing && editingItem ? editingItem.category : '');
        const [method, setMethod] = useState(editing && editingItem ? editingItem.method : 'cash');
        const [date, setDate] = useState(editing && editingItem ? editingItem.date : new Date().toISOString().split('T')[0]);
        const [showCats, setShowCats] = useState(false);
        const [confirmDel, setConfirmDel] = useState(false);
        const [photoTaken, setPhotoTaken] = useState(editing ? true : false);
        const [pendingReceipt, setPendingReceipt] = useState(editing && editingItem?.receipt ? editingItem.receipt : null);
        const [scanningLocal, setScanningLocal] = useState(false);
        const [scanProgress, setScanProgress] = useState(0);
        const [scanStatus, setScanStatus] = useState('');
        const [lastScanInfo, setLastScanInfo] = useState(null);
        const [showReceiptDetails, setShowReceiptDetails] = useState(false);
        const [subtotal, setSubtotal] = useState(editing && editingItem?.subtotal ? editingItem.subtotal.toString() : '');
        const [gst, setGst] = useState(editing && editingItem?.gst ? editingItem.gst.toString() : '');
        const [discount, setDiscount] = useState('');
        const [paymentMethod, setPaymentMethod] = useState(editing && editingItem?.paymentMethod || '');
        const [cardLastFour, setCardLastFour] = useState('');
        const [showReceiptImage, setShowReceiptImage] = useState(false);

        const fileInputRef = useRef(null);

        // FIX: Recovery on mount
        useEffect(() => {
          if (editing) return;
          
          const session = ScanSession.get();
          if (session && session.image) {
            console.log('Recovering scan session from', Math.round((Date.now() - session.savedAt) / 1000), 's ago');
            
            setPendingReceipt({
              originalImage: session.image,
              vendor: session.vendor || '',
              total: session.total || 0,
              items: session.items || [],
              rawText: session.rawText || '',
              subtotal: session.subtotal,
              gst: session.gst,
              paymentMethod: session.paymentMethod
            });
            setPhotoTaken(true);
            
            if (session.total) setAmount(session.total.toString());
            if (session.vendor) setDescription(session.vendor);
            if (session.category) setCategory(session.category);
            if (session.date) setDate(session.date);
            if (session.subtotal) setSubtotal(session.subtotal.toString());
            if (session.gst) setGst(session.gst.toString());
            if (session.paymentMethod) {
              setPaymentMethod(session.paymentMethod);
              setMethod(session.paymentMethod === 'Cash' ? 'cash' : 'bank');
            }
            
            if (session.total) {
              setLastScanInfo({ success: true, message: 'Recovered! Review and save.' });
            } else {
              setLastScanInfo({ success: true, message: 'Photo recovered! Tap "Autofill with AI" to scan.' });
            }
            
            if (session.subtotal || session.gst || session.paymentMethod) setShowReceiptDetails(true);
            return;
          }
          
          // Fallback: old keys
          const pendingImage = localStorage.getItem('pending_scan_image');
          const pendingResult = localStorage.getItem('pending_scan_result');
          
          if (pendingResult) {
            try {
              const result = JSON.parse(pendingResult);
              if (Date.now() - (result.savedAt || 0) < 60000) {
                if (result.total) setAmount(result.total.toString());
                if (result.vendor) setDescription(result.vendor);
                if (result.category) setCategory(result.category);
                if (result.originalImage) {
                  setPendingReceipt({ originalImage: result.originalImage, ...result });
                  setPhotoTaken(true);
                }
              }
            } catch (e) {}
            localStorage.removeItem('pending_scan_result');
          } else if (pendingImage) {
            const pendingTime = localStorage.getItem('pending_scan_time');
            if (pendingTime && Date.now() - parseInt(pendingTime) < 60000) {
              setPendingReceipt({ originalImage: pendingImage, vendor: '', total: 0 });
              setPhotoTaken(true);
              setLastScanInfo({ success: true, message: 'Photo recovered! Tap "Autofill with AI" to scan.' });
            }
            localStorage.removeItem('pending_scan_image');
            localStorage.removeItem('pending_scan_time');
          }
        }, [editing]);

        // FIX: Save state when page backgrounded
        useEffect(() => {
          const handleVis = () => {
            if (document.visibilityState === 'hidden' && pendingReceipt?.originalImage) {
              console.log('Page hidden - saving scan session');
              ScanSession.save({
                image: pendingReceipt.originalImage,
                vendor: description || pendingReceipt.vendor,
                total: parseFloat(amount) || pendingReceipt.total,
                category: category,
                date: date,
                items: pendingReceipt.items,
                rawText: pendingReceipt.rawText,
                subtotal: subtotal ? parseFloat(subtotal) : pendingReceipt.subtotal,
                gst: gst ? parseFloat(gst) : pendingReceipt.gst,
                paymentMethod: paymentMethod || pendingReceipt.paymentMethod
              });
            }
          };
          document.addEventListener('visibilitychange', handleVis);
          return () => document.removeEventListener('visibilitychange', handleVis);
        }, [pendingReceipt, amount, description, category, date, subtotal, gst, paymentMethod]);

        // FIX: Open camera with breadcrumb saved FIRST
        const handleOpenCamera = (e) => {
          e.preventDefault();
          sessionStorage.setItem('return_to_screen', 'addExpense');
          ScanSession.save({ cameraOpenedAt: Date.now() });
          console.log('Opening camera, breadcrumb saved');
          fileInputRef.current?.click();
        };

        // FIX: Handle file without reload
        const handleScan = async (e) => {
          const file = e.target.files?.[0];
          if (!file) return;
          
          console.log('File selected:', file.name, Math.round(file.size / 1024), 'KB');
          setScanningLocal(true);
          setScanProgress(10);
          setScanStatus('Reading photo...');
          
          try {
            const base64 = await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = () => resolve(reader.result.split(',')[1]);
              reader.onerror = reject;
              reader.readAsDataURL(file);
            });
            
            console.log('Read file:', Math.round(base64.length / 1024), 'KB');
            setScanProgress(30);
            setScanStatus('Compressing...');
            
            const compressed = await compressForStorage(base64, 400);
            console.log('Compressed to:', Math.round(compressed.length / 1024), 'KB');
            
            setScanProgress(50);
            setScanStatus('Saving...');
            
            ScanSession.save({ image: compressed, cameraOpenedAt: Date.now() });
            
            setPendingReceipt({ originalImage: compressed, scannedAt: new Date().toISOString(), vendor: '', total: 0 });
            setPhotoTaken(true);
            
            setScanProgress(100);
            setScanStatus('Photo ready!');
            setLastScanInfo({ success: true, message: 'Photo captured! Tap "Autofill with AI" to scan.' });
            
          } catch (error) {
            console.error('Error reading file:', error);
            setLastScanInfo({ error: true, message: 'Failed to read photo: ' + error.message });
          } finally {
            setScanningLocal(false);
            setTimeout(() => { setScanProgress(0); setScanStatus(''); }, 1000);
          }
        };

        // FIX: AI scan without reload
        const runAIScan = async () => {
          if (!pendingReceipt?.originalImage) {
            setLastScanInfo({ error: true, message: 'No image to scan' });
            return;
          }
          
          setScanningLocal(true);
          setScanProgress(0);
          setScanStatus('Initializing...');
          
          try {
            setScanProgress(10);
            setScanStatus('Sending to Google Vision...');
            
            const response = await fetch('/api/vision', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ image: pendingReceipt.originalImage })
            });
            
            setScanProgress(50);
            setScanStatus('Processing...');
            
            const result = await response.json();
            
            if (!response.ok || result.error) {
              throw new Error(result.error || 'Vision API failed');
            }
            
            setScanProgress(70);
            setScanStatus('Parsing receipt...');
            
            const text = result.text || '';
            const parsed = parseReceiptText(text);
            
            setScanProgress(90);
            setScanStatus('Filling form...');
            
            if (parsed.total) setAmount(parsed.total.toString());
            if (parsed.vendor) setDescription(parsed.vendor);
            if (parsed.category) setCategory(parsed.category);
            if (parsed.date) setDate(parsed.date);
            if (parsed.subtotal) setSubtotal(parsed.subtotal.toString());
            if (parsed.gst) setGst(parsed.gst.toString());
            if (parsed.discount) setDiscount(parsed.discount.toString());
            if (parsed.paymentMethod) {
              setPaymentMethod(parsed.paymentMethod);
              setMethod(parsed.paymentMethod === 'Cash' ? 'cash' : 'bank');
            }
            if (parsed.cardLastFour) setCardLastFour(parsed.cardLastFour);
            
            if (parsed.subtotal || parsed.gst || parsed.paymentMethod) setShowReceiptDetails(true);
            
            const updatedReceipt = {
              ...pendingReceipt,
              vendor: parsed.vendor,
              total: parsed.total,
              items: parsed.items,
              rawText: text,
              subtotal: parsed.subtotal,
              gst: parsed.gst,
              discount: parsed.discount,
              paymentMethod: parsed.paymentMethod,
              cardLastFour: parsed.cardLastFour
            };
            setPendingReceipt(updatedReceipt);
            
            ScanSession.save({
              image: pendingReceipt.originalImage,
              vendor: parsed.vendor,
              total: parsed.total,
              category: parsed.category,
              date: parsed.date,
              items: parsed.items,
              rawText: text,
              subtotal: parsed.subtotal,
              gst: parsed.gst,
              paymentMethod: parsed.paymentMethod
            });
            
            setScanProgress(100);
            setScanStatus('Complete!');
            
            setLastScanInfo({
              vendor: parsed.vendor,
              total: parsed.total,
              success: true,
              message: parsed.total ? 'Found: ' + (parsed.vendor || 'Receipt') + ' - $' + parsed.total : 'Scan complete - check details'
            });
            
          } catch (error) {
            console.error('OCR error:', error);
            setLastScanInfo({ error: true, message: 'Scan failed: ' + error.message });
          } finally {
            setScanningLocal(false);
            setTimeout(() => { setScanProgress(0); setScanStatus(''); }, 1500);
            setTimeout(() => setLastScanInfo(null), 8000);
          }
        };

        const handleSubmit = () => {
          if (!amount || !category) return;
          const data = {
            amount: parseFloat(amount),
            category,
            description: description.trim(),
            method,
            date,
            receipt: pendingReceipt || null,
            ...(subtotal && { subtotal: parseFloat(subtotal) }),
            ...(gst && { gst: parseFloat(gst) }),
            ...(paymentMethod && { paymentMethod })
          };
          if (editing && editingItem) updateExpense(editingItem.id, data);
          else addExpense(data);
          ScanSession.clear();
          setScreen('expenses');
          setEditingItem(null);
        };

        const handleDel = () => {
          if (confirmDel) { deleteExpense(editingItem.id); ScanSession.clear(); setScreen('expenses'); setEditingItem(null); }
          else { setConfirmDel(true); setTimeout(() => setConfirmDel(false), 3000); }
        };

        const handleBack = () => {
          ScanSession.clear();
          setScreen(editing ? 'expenses' : 'home');
          setEditingItem(null);
        };

        const retakePhoto = () => {
          setPendingReceipt(null);
          setPhotoTaken(false);
          setLastScanInfo(null);
          ScanSession.clear();
        };

        const selCat = category ? getCategoryById(category) : null;
        const groupedCats = useMemo(() => {
          const groups = {};
          EXPENSE_CATEGORIES.forEach(cat => {
            if (!groups[cat.group]) groups[cat.group] = [];
            groups[cat.group].push(cat);
          });
          return groups;
        }, []);

        return (
          <div className="min-h-screen bg-slate-950 text-white pb-24">
            <div className="px-5 pt-8">
              <button onClick={handleBack} className="text-slate-500 text-sm mb-4">‚Üê Back</button>
              <div className="flex justify-between items-center mb-6">
                <h1 className="text-2xl font-bold">{editing ? "Edit Expense" : "Add Expense"}</h1>
                <CatLangSelector />
              </div>

              <input type="file" ref={fileInputRef} accept="image/*" capture="environment" onChange={handleScan} className="hidden" />

              {!photoTaken && !editing && (
                <div className="mb-6">
                  <button type="button" onClick={handleOpenCamera} className="w-full py-4 bg-gradient-to-r from-purple-600 to-pink-600 rounded-2xl text-lg font-bold flex items-center justify-center gap-3">
                    üì∑ Add Photo
                  </button>
                  <p className="text-slate-500 text-xs text-center mt-2">Or enter details manually below</p>
                </div>
              )}

              {(scanningLocal || scanProgress > 0) && <ProgressBar progress={scanProgress} status={scanStatus} />}

              {lastScanInfo && (
                <div className={`rounded-xl p-3 mb-4 ${lastScanInfo.error ? 'bg-red-900/30 border border-red-700/50' : 'bg-green-900/30 border border-green-700/50'}`}>
                  <p className={`text-sm ${lastScanInfo.error ? 'text-red-300' : 'text-green-300'}`}>{lastScanInfo.message}</p>
                </div>
              )}

              {photoTaken && pendingReceipt?.originalImage && (
                <div className="mb-4">
                  <div className="bg-slate-900 rounded-xl p-3">
                    <div className="flex items-center gap-3 mb-3">
                      <div className="w-16 h-16 rounded-lg overflow-hidden bg-slate-800 cursor-pointer" onClick={() => setShowReceiptImage(true)}>
                        <img src={'data:image/jpeg;base64,' + pendingReceipt.originalImage} className="w-full h-full object-cover" alt="Receipt" />
                      </div>
                      <div className="flex-1">
                        <p className="text-white font-medium">Receipt Photo</p>
                        <p className="text-slate-500 text-xs">{pendingReceipt.vendor || 'Tap to view full size'}</p>
                      </div>
                      <button onClick={retakePhoto} className="px-3 py-1.5 bg-slate-800 rounded-lg text-sm text-slate-400">Retake</button>
                    </div>
                    <button onClick={runAIScan} disabled={scanningLocal} className="w-full py-3 bg-gradient-to-r from-cyan-600 to-blue-600 rounded-xl font-medium disabled:opacity-50">
                      {scanningLocal ? 'üîÑ Scanning...' : 'ü§ñ Autofill with AI'}
                    </button>
                  </div>
                </div>
              )}

              {showReceiptImage && pendingReceipt?.originalImage && (
                <div className="fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4" onClick={() => setShowReceiptImage(false)}>
                  <img src={'data:image/jpeg;base64,' + pendingReceipt.originalImage} className="max-w-full max-h-full object-contain" alt="Receipt" />
                  <button className="absolute top-4 right-4 w-10 h-10 bg-white/20 rounded-full text-white text-xl">√ó</button>
                </div>
              )}

              <div className="mb-4">
                <label className="text-slate-400 text-sm mb-2 block">Amount *</label>
                <div className="relative">
                  <span className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xl">$</span>
                  <input type="number" value={amount} onChange={(e) => setAmount(e.target.value)} placeholder="0.00" className="w-full bg-slate-900 rounded-xl px-4 py-4 pl-10 text-2xl font-bold text-white placeholder-slate-600 outline-none" />
                </div>
              </div>

              {(showReceiptDetails || subtotal || gst) && (
                <div className="mb-4 bg-slate-900/50 rounded-xl p-3 space-y-2">
                  <div className="flex gap-2">
                    <div className="flex-1"><label className="text-slate-500 text-xs">Subtotal</label><input type="number" value={subtotal} onChange={(e) => setSubtotal(e.target.value)} placeholder="0.00" className="w-full bg-slate-800 rounded-lg px-3 py-2 text-white text-sm" /></div>
                    <div className="flex-1"><label className="text-slate-500 text-xs">GST (15%)</label><input type="number" value={gst} onChange={(e) => setGst(e.target.value)} placeholder="0.00" className="w-full bg-slate-800 rounded-lg px-3 py-2 text-white text-sm" /></div>
                  </div>
                  {paymentMethod && <p className="text-slate-500 text-xs">Payment: {paymentMethod}{cardLastFour ? ' ****' + cardLastFour : ''}</p>}
                </div>
              )}

              <div className="mb-4">
                <label className="text-slate-400 text-sm mb-2 block">Category *</label>
                <button onClick={() => setShowCats(true)} className="w-full bg-slate-900 rounded-xl px-4 py-3 text-left flex items-center gap-3">
                  {selCat ? <><span className="text-xl">{selCat.icon}</span><span className="text-white">{getCategoryName(selCat)}</span></> : <span className="text-slate-600">Select category</span>}
                </button>
              </div>

              {showCats && (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4" onClick={() => setShowCats(false)}>
                  <div className="absolute inset-0 bg-slate-950/80 backdrop-blur-sm fade-in" />
                  <div className="relative bg-slate-900 w-full max-w-md max-h-[80vh] rounded-2xl border border-slate-700 slide-in overflow-hidden" onClick={(e) => e.stopPropagation()}>
                    <div className="flex justify-between items-center p-4 border-b border-slate-800">
                      <h2 className="text-lg font-bold text-white">Select Category</h2>
                      <button onClick={() => setShowCats(false)} className="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center text-slate-400">√ó</button>
                    </div>
                    <div className="overflow-y-auto max-h-[60vh] p-4">
                      {Object.entries(groupedCats).map(([groupId, cats]) => (
                        <div key={groupId} className="mb-4">
                          <p className="text-xs font-medium text-slate-500 mb-2 uppercase">{CATEGORY_GROUPS[groupId]?.name || groupId}</p>
                          <div className="grid grid-cols-3 gap-2">
                            {cats.map(cat => (
                              <button key={cat.id} onClick={() => { setCategory(cat.id); setShowCats(false); }} className={`p-3 rounded-xl flex flex-col items-center gap-1 ${category === cat.id ? 'ring-2 ring-cyan-400 bg-cyan-900/30' : 'bg-slate-800'}`}>
                                <span className="text-xl">{cat.icon}</span>
                                <span className="text-xs text-white text-center leading-tight">{cat.en}</span>
                              </button>
                            ))}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              )}

              <div className="mb-4">
                <label className="text-slate-400 text-sm mb-2 block">Description</label>
                <input type="text" value={description} onChange={(e) => setDescription(e.target.value)} placeholder="(optional)" className="w-full bg-slate-900 rounded-xl px-4 py-3 text-white placeholder-slate-600 outline-none" />
              </div>

              <div className="mb-4">
                <label className="text-slate-400 text-sm mb-2 block">Method</label>
                <div className="grid grid-cols-2 gap-2">
                  <button onClick={() => setMethod('cash')} className={`py-3 rounded-xl font-medium ${method === 'cash' ? 'bg-green-600 text-white' : 'bg-slate-900 text-slate-400'}`}>üíµ Cash</button>
                  <button onClick={() => setMethod('bank')} className={`py-3 rounded-xl font-medium ${method === 'bank' ? 'bg-blue-600 text-white' : 'bg-slate-900 text-slate-400'}`}>üè¶ Bank</button>
                </div>
              </div>

              <div className="mb-6">
                <label className="text-slate-400 text-sm mb-2 block">Date</label>
                <input type="date" value={date} onChange={(e) => setDate(e.target.value)} className="w-full bg-slate-900 rounded-xl px-4 py-3 text-white" />
              </div>

              <button onClick={handleSubmit} disabled={!amount || !category} className="w-full py-4 bg-gradient-to-r from-orange-600 to-red-600 rounded-xl font-bold text-lg disabled:opacity-50">
                {editing ? "Save" : "Add"}
              </button>

              {editing && <button onClick={handleDel} className={`w-full py-3 mt-3 rounded-xl font-medium ${confirmDel ? 'bg-red-600 text-white' : 'bg-slate-900 text-red-400'}`}>{confirmDel ? 'Tap to confirm' : 'Delete'}</button>}
            </div>
            <Nav />
          </div>
        );
      };

      // Analytics Screen
      const Analytics = () => {
        const [tab, setTab] = useState('overview');

        const expensesByCategory = useMemo(() => {
          const cats = {};
          expenses.forEach(e => {
            const cat = getCategoryById(e.category);
            if (!cats[cat.id]) cats[cat.id] = { cat, total: 0, count: 0 };
            cats[cat.id].total += e.amount;
            cats[cat.id].count++;
          });
          return Object.values(cats).sort((a, b) => b.total - a.total);
        }, [expenses]);

        const giftsByCategory = useMemo(() => {
          const cats = {};
          gifts.forEach(g => {
            const cat = getGiftCategoryById(g.category || 'isi');
            if (!cats[cat.id]) cats[cat.id] = { cat, total: 0, count: 0 };
            cats[cat.id].total += g.amount;
            cats[cat.id].count++;
          });
          return Object.values(cats).sort((a, b) => b.total - a.total);
        }, [gifts]);

        const topDonors = useMemo(() => {
          const d = {};
          gifts.forEach(g => { d[g.donor] = (d[g.donor] || 0) + g.amount; });
          return Object.entries(d).sort((a, b) => b[1] - a[1]).slice(0, 10);
        }, [gifts]);

        const expensePieData = useMemo(() => {
          const grouped = {};
          expenses.forEach(e => {
            const cat = getCategoryById(e.category);
            const group = cat.group;
            if (!grouped[group]) grouped[group] = 0;
            grouped[group] += e.amount;
          });
          return Object.entries(grouped).map(([g, v]) => ({ label: CATEGORY_GROUPS[g]?.name.split(' ‚Ä¢ ')[0] || g, value: v, color: CATEGORY_GROUPS[g]?.color || '#64748b' }));
        }, [expenses]);

        const giftPieData = useMemo(() => {
          return giftsByCategory.map(({ cat, total }) => ({ label: cat.en, value: total, color: cat.color }));
        }, [giftsByCategory]);

        return (
          <div className="min-h-screen bg-slate-950 text-white pb-24">
            <div className="px-5 pt-8">
              <h1 className="text-2xl font-bold mb-4">Analytics</h1>

              <div className="flex gap-2 mb-6 overflow-x-auto pb-2">
                {[{ id: 'overview', label: 'üìä Overview' }, { id: 'expenses', label: 'üí∏ Expenses' }, { id: 'gifts', label: 'üéÅ Gifts' }, { id: 'flagged', label: '‚ö†Ô∏è Review (' + (flaggedExpenses.length + flaggedGifts.length) + ')' }].map(t => (
                  <button key={t.id} onClick={() => setTab(t.id)} className={`px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap ${tab === t.id ? 'bg-cyan-600 text-white' : 'bg-slate-900 text-slate-400'}`}>{t.label}</button>
                ))}
              </div>

              {tab === 'overview' && (
                <div className="space-y-6">
                  <div className="bg-slate-900 rounded-xl p-4">
                    <h2 className="text-lg font-bold mb-4">Summary</h2>
                    <div className="grid grid-cols-2 gap-4">
                      <div><p className="text-slate-500 text-sm">Total In</p><p className="text-2xl font-bold text-green-400">{fmt(totals.giftsTotal)}</p></div>
                      <div><p className="text-slate-500 text-sm">Total Out</p><p className="text-2xl font-bold text-red-400">{fmt(totals.expensesTotal)}</p></div>
                      <div><p className="text-slate-500 text-sm">Balance</p><p className={`text-2xl font-bold ${totals.balanceTotal < 0 ? 'text-red-400' : 'text-cyan-400'}`}>{fmt(totals.balanceTotal)}</p></div>
                      <div><p className="text-slate-500 text-sm">Transactions</p><p className="text-2xl font-bold text-white">{gifts.length + expenses.length}</p></div>
                    </div>
                  </div>
                  {expenses.length > 0 && <div className="bg-slate-900 rounded-xl p-4"><PieChart data={expensePieData} title="Expenses by Category" /></div>}
                  {gifts.length > 0 && <div className="bg-slate-900 rounded-xl p-4"><PieChart data={giftPieData} title="Gifts by Source" /></div>}
                </div>
              )}

              {tab === 'expenses' && (
                <div className="space-y-4">
                  <button onClick={() => validateExpenses()} disabled={isValidating} className="w-full py-3 bg-amber-600 rounded-xl font-medium disabled:opacity-50">{isValidating ? 'üîÑ Validating...' : 'üîç Quick Validate All'}</button>
                  {expensesByCategory.map(({ cat, total, count }) => (
                    <div key={cat.id} className="bg-slate-900 rounded-xl p-4">
                      <div className="flex items-center gap-3">
                        <span className="text-2xl">{cat.icon}</span>
                        <div className="flex-1"><p className="font-medium text-white">{getCategoryName(cat)}</p><p className="text-slate-500 text-sm">{count} items</p></div>
                        <p className="text-red-400 font-bold">{fmt(total)}</p>
                      </div>
                    </div>
                  ))}
                  {expensesByCategory.length === 0 && <p className="text-slate-500 text-center py-8">No expenses yet</p>}
                </div>
              )}

              {tab === 'gifts' && (
                <div className="space-y-4">
                  <div className="bg-slate-900 rounded-xl p-4">
                    <h3 className="text-sm font-medium text-slate-400 mb-3">TOP DONORS</h3>
                    {topDonors.map(([name, amount], i) => (
                      <div key={name} className="flex items-center gap-3 py-2 border-b border-slate-800 last:border-0">
                        <span className="w-6 h-6 bg-slate-800 rounded-full flex items-center justify-center text-xs text-slate-400">{i + 1}</span>
                        <p className="flex-1 text-white">{name}</p>
                        <p className="text-green-400 font-medium">{fmt(amount)}</p>
                      </div>
                    ))}
                    {topDonors.length === 0 && <p className="text-slate-500 text-center py-4">No gifts yet</p>}
                  </div>
                  <div className="bg-slate-900 rounded-xl p-4">
                    <h3 className="text-sm font-medium text-slate-400 mb-3">BY CATEGORY</h3>
                    {giftsByCategory.map(({ cat, total, count }) => (
                      <div key={cat.id} className="flex items-center gap-3 py-2 border-b border-slate-800 last:border-0">
                        <span className="text-xl">{cat.icon}</span>
                        <div className="flex-1"><p className="text-white">{getCategoryName(cat)}</p><p className="text-slate-500 text-xs">{count} gifts</p></div>
                        <p className="text-green-400 font-medium">{fmt(total)}</p>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {tab === 'flagged' && (
                <div className="space-y-4">
                  {flaggedExpenses.length === 0 && flaggedGifts.length === 0 ? (
                    <div className="text-center py-12"><span className="text-4xl mb-4 block">‚úÖ</span><p className="text-slate-400">All items look good!</p><button onClick={() => validateExpenses()} disabled={isValidating} className="mt-4 px-6 py-2 bg-slate-800 rounded-xl text-sm">{isValidating ? 'Checking...' : 'Run Check'}</button></div>
                  ) : (
                    <>
                      {flaggedExpenses.length > 0 && <p className="text-slate-400 text-sm font-medium">EXPENSES ({flaggedExpenses.length})</p>}
                      {flaggedExpenses.map(e => {
                        const cat = getCategoryById(e.category);
                        const r = validationResults[e.id];
                        return (
                          <div key={e.id} className="bg-slate-900 rounded-xl p-4 border border-amber-500/50">
                            <div className="flex items-start gap-3 mb-3">
                              <span className="text-2xl">{cat.icon}</span>
                              <div className="flex-1"><p className="font-medium text-white">{e.description || getCategoryName(cat)}</p><p className="text-slate-500 text-sm">{fmtDateFull(e.date)} ‚Ä¢ {fmt(e.amount)}</p></div>
                            </div>
                            {r && (
                              <div className="bg-amber-900/30 rounded-lg p-3 mb-3">
                                <p className="text-amber-200 text-sm">{r.reason}</p>
                                {r.suggested && <p className="text-amber-400 text-sm mt-1">Suggested: <strong>{r.suggested}</strong></p>}
                              </div>
                            )}
                            <div className="flex gap-2">
                              {r?.suggestedId && <button onClick={() => applySuggestion(e.id, r.suggestedId)} className="flex-1 py-2 bg-green-600 rounded-lg text-sm font-medium">‚úì Apply</button>}
                              <button onClick={() => dismissSuggestion(e.id)} className="flex-1 py-2 bg-slate-800 rounded-lg text-sm text-slate-400">Dismiss</button>
                              <button onClick={() => { setEditingItem(e); setScreen('editExpense'); }} className="px-4 py-2 bg-slate-800 rounded-lg text-sm text-slate-400">Edit</button>
                            </div>
                          </div>
                        );
                      })}
                      {flaggedGifts.length > 0 && <p className="text-slate-400 text-sm font-medium mt-6">GIFTS ({flaggedGifts.length})</p>}
                      {flaggedGifts.map(g => {
                        const cat = getGiftCategoryById(g.category);
                        const r = giftValidationResults[g.id];
                        return (
                          <div key={g.id} className="bg-slate-900 rounded-xl p-4 border border-amber-500/50">
                            <div className="flex items-start gap-3 mb-3">
                              <span className="text-2xl">{cat.icon}</span>
                              <div className="flex-1"><p className="font-medium text-white">{g.donor}</p><p className="text-slate-500 text-sm">{fmtDateFull(g.date)} ‚Ä¢ {fmt(g.amount)}</p></div>
                            </div>
                            {r && (
                              <div className="bg-amber-900/30 rounded-lg p-3 mb-3">
                                <p className="text-amber-200 text-sm">{r.reason}</p>
                                {r.suggested && <p className="text-amber-400 text-sm mt-1">Suggested: <strong>{r.suggested}</strong></p>}
                              </div>
                            )}
                            <div className="flex gap-2">
                              {r?.suggestedId && <button onClick={() => applyGiftSuggestion(g.id, r.suggestedId)} className="flex-1 py-2 bg-green-600 rounded-lg text-sm font-medium">‚úì Apply</button>}
                              <button onClick={() => dismissGiftSuggestion(g.id)} className="flex-1 py-2 bg-slate-800 rounded-lg text-sm text-slate-400">Dismiss</button>
                              <button onClick={() => { setEditingItem(g); setScreen('editGift'); }} className="px-4 py-2 bg-slate-800 rounded-lg text-sm text-slate-400">Edit</button>
                            </div>
                          </div>
                        );
                      })}
                    </>
                  )}
                </div>
              )}
            </div>
            <Nav />
          </div>
        );
      };

      // Render screens
      return (
        <>
          {screen === 'home' && <Home />}
          {screen === 'gifts' && <Gifts />}
          {screen === 'addGift' && <AddGift />}
          {screen === 'editGift' && <AddGift editing={true} />}
          {screen === 'expenses' && <Expenses />}
          {screen === 'addExpense' && <AddExpense />}
          {screen === 'editExpense' && <AddExpense editing={true} />}
          {screen === 'addTransfer' && <AddTransfer />}
          {screen === 'sync' && <SyncScreen />}
          {screen === 'analytics' && <Analytics />}
        </>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
